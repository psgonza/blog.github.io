<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>bynario.com</title>
  <meta name="author" content="psgonza">

  <link href="/rss.xml" type="application/rss+xml" rel="alternate"
        title="bynario.com RSS Feed" />



  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


    <link href="/favicon.png" rel="icon">

  <link href="/theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">

  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="/"><img src="https://dl.dropboxusercontent.com/u/14814182/blog/bynario_logo.gif"></a></h1>
</hgroup></header>
  <nav role="navigation">
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>

<ul class="main-navigation">
    <li><a href="/">Home</a></li>
    <li><a href="/category/posts.html">Posts</a></li>
    <li><a href="/rss.xml">RSS</a></li>
</ul></nav>
  <div id="main">
    <div id="content">
<div class="blog-index">
  		<article>
<header>
      <h1 class="entry-title">
        <a href="/2015-07-07-from-octopress-to-pelican.html">From Octopress to Pelican</a>
      </h1>
    <p class="meta">
<time datetime="2015-07-07T23:00:00+02:00" pubdate>Tue 07 July 2015</time>    </p>
</header>

  <div class="entry-content"><p>Finally I had some time to move away from Octopress... After trying a couple of <a href="https://wiki.python.org/moin/StaticSiteGenerator">Python static web generators</a> I decided to give <a href="http://getpelican.com">Pelican</a> a try.</p>
<p>The "migration" was pretty easy. Install it via pip, configure your list of plugins and pages, update your posts (you have to do slightly modifications to your Octopress header posts) and you are good to go... I even managed to keep the same design I already had (thanks to this <a href="https://github.com/duilio/pelican-octopress-theme">octopress theme</a>) </p>
<p>So far, it feels good to have an easy bloggin platform in Python, so I totally recommend the change!</p>
<p>Later</p></div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="/2015-01-10-bye-2014-hello-2015.html">Bye 2014 && Hello 2015</a>
      </h1>
    <p class="meta">
<time datetime="2015-01-10T21:41:03+02:00" pubdate>Sat 10 January 2015</time>    </p>
</header>

  <div class="entry-content"><p>It is time to say goodbye to 2014... This is how I saw it from my old Samsung Galaxy S3:</p>
<p>{% img center /img/2014byphone.JPG  '2014' %}</p>
<p>(50% business/50% leisure)</p>
<p>Happy New Year 2015!!! I'll see you around!</p></div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="/2014-10-19-easy-blogging-git.html">Easy blogging: Octopress, Git and Docker</a>
      </h1>
    <p class="meta">
<time datetime="2014-11-02T10:00:02+02:00" pubdate>Sun 02 November 2014</time>    </p>
</header>

  <div class="entry-content"><p><a href="https://www.docker.com">Docker</a> has been probably 2014 revelation (at least in IT world), so I have decided to get my hands on it, and at the same time, try to solve my "problem" with Ruby.</p>
<p>My idea is to "Dockerize" Octopress environment, and run it from a container every time I need to recreate the blog. And also, instead of keeping the blog posts (markdown files) locally, I will store them in a Git repository, and configure Git-hooks so the blog is recreated automatically.</p>
<p>First of all, make sure you have Docker and Git installed in your server.</p>
<p>In order to be able to build the blog, we will need <a href="http://octopress.org">Octopress</a> source code. You can use your current Octopress installation or download it from Github:</p>
<div class="highlight"><pre><span></span>$ git clone http://github.com/imathis/octopress.git octopress
$ <span class="nb">cd</span> octopress
</pre></div>


<p>Once Octopress is downloaded, let's create our Docker container using this <a href="http://docs.docker.com/reference/builder/">Dockerfile</a>:</p>
<div class="highlight"><pre><span></span><span class="k">FROM</span> <span class="n">ubuntu</span><span class="p">:</span><span class="mi">14</span><span class="p">.</span><span class="mi">10</span>

<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="k">get</span> <span class="k">update</span>
<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="k">get</span> <span class="n">install</span> <span class="n">git</span> <span class="n">ruby1</span><span class="p">.</span><span class="mi">9</span><span class="p">.</span><span class="mi">3</span> <span class="n">ruby</span><span class="o">-</span><span class="n">dev</span> <span class="n">build</span><span class="o">-</span><span class="n">essential</span> <span class="k">language</span><span class="o">-</span><span class="n">pack</span><span class="o">-</span><span class="n">en</span> <span class="n">nodejs</span> <span class="n">python</span> <span class="o">-</span><span class="n">y</span>

<span class="n">ENV</span> <span class="n">LC_ALL</span> <span class="n">en_US</span><span class="p">.</span><span class="n">utf8</span>

<span class="k">ADD</span> <span class="p">.</span> <span class="o">/</span><span class="n">blogSRC</span>
<span class="n">WORKDIR</span> <span class="o">/</span><span class="n">blogSRC</span>

<span class="n">RUN</span> <span class="n">adduser</span> <span class="c1">--uid 1000 --gid 50 deploy</span>
<span class="n">RUN</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">deploy</span><span class="p">:</span><span class="n">staff</span> <span class="o">/</span><span class="n">blogSRC</span>
<span class="k">USER</span> <span class="n">deploy</span>

<span class="n">RUN</span> <span class="n">gem</span> <span class="n">install</span> <span class="n">bundler</span>
<span class="n">RUN</span> <span class="n">bundle</span> <span class="n">install</span>

<span class="n">ENTRYPOINT</span> <span class="p">[</span><span class="ss">&quot;rake&quot;</span><span class="p">]</span>
</pre></div>


<p>This container will download and install Ruby environment and its dependences (There are some compatibility issues with Python3, so 2.7 has to be installed. See <a href="https://github.com/imathis/octopress/issues/1651">this</a>), so we are able to run <code>rake</code> commands. </p>
<p>Build the container:</p>
<div class="highlight"><pre><span></span>$ sudo docker build -t bynario/octopress .
Sending build context to Docker daemon <span class="m">3</span>.829 MB
Sending build context to Docker daemon
Step <span class="m">0</span> : FROM ubuntu:14.10
 ---&gt; accae238329d
Step <span class="m">1</span> : RUN apt-get update
 ---&gt; Running in 5a456e103939
...
...
...
Step <span class="m">11</span> : ENTRYPOINT <span class="o">[</span><span class="s2">&quot;rake&quot;</span><span class="o">]</span>
 ---&gt; Running in c74572f9fb1a
 ---&gt; 94d1b90e8e03
Removing intermediate container c74572f9fb1a
Successfully built 94d1b90e8e03
</pre></div>


<p>If it goes fine, you will see your new container by listing the images:</p>
<div class="highlight"><pre><span></span>$ docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
bynario/octopress   latest              94d1b90e8e03        About an hour ago   <span class="m">531</span>.8 MB
ubuntu              <span class="m">14</span>.10               accae238329d        <span class="m">4</span> days ago          <span class="m">221</span>.1 MB
$
</pre></div>


<p>If you downloaded Octopress from Github in Step 1, then we need to install it. Since we already have our container ready, let's use it:</p>
<div class="highlight"><pre><span></span>$ sudo docker run --rm -v /home/docker/octopress/:/blogSRC bynario/octopress install
mkdir -p <span class="nb">source</span>
cp -r .themes/classic/source/. <span class="nb">source</span>
mkdir -p sass
cp -r .themes/classic/sass/. sass
mkdir -p source/_posts
mkdir -p public
<span class="c1">## Copying classic theme into ./source and ./sass</span>
$
</pre></div>


<p>(<code>/home/docker/octopress/</code> is my path to octopress installation folder, change it to fit your installation)</p>
<p>At this point our Octopress is propely installed, and Ruby is running from a Docker container, so there shouldn't be more issues with Ruby and system upgrades.</p>
<p>Now, let's get the posts from our git repository and configure the git-hook. For this I will assume that the posts are already commited and pushed to your git server (Github, BitBicker, etc), and your repositories are working just fine (ssh keys, users, etc..).</p>
<div class="highlight"><pre><span></span><span class="n">cd</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">octopress</span><span class="o">/</span><span class="n">source</span><span class="o">/</span><span class="n">_posts</span><span class="w"></span>
<span class="n">git</span><span class="w"> </span><span class="n">init</span><span class="w"></span>
<span class="n">git</span><span class="w"> </span><span class="n">remote</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="n">origin</span><span class="w"> </span><span class="n">git</span><span class="nv">@server</span><span class="p">.</span><span class="k">domain</span><span class="err">:</span><span class="k">path</span><span class="o">/</span><span class="n">repository</span><span class="p">.</span><span class="n">git</span><span class="w"></span>
<span class="n">git</span><span class="w"> </span><span class="n">pull</span><span class="w"> </span><span class="n">origin</span><span class="w"> </span><span class="n">master</span><span class="w"></span>
</pre></div>


<p>(Again, use the path that fits your installation, and update <code>git@server.domain:path/repository.git</code> with your own repository)</p>
<p>Now all the posts are in the <code>_posts</code> folder:</p>
<div class="highlight"><pre><span></span><span class="o">~/</span><span class="n">octopress</span><span class="o">/</span><span class="k">source</span><span class="o">/</span><span class="n">_posts$</span> <span class="n">ls</span> <span class="o">-</span><span class="mi">1</span>
<span class="mi">2011</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="n">tips</span><span class="o">-</span><span class="n">instalar</span><span class="o">-</span><span class="n">vmware</span><span class="o">-</span><span class="n">en</span><span class="o">-</span><span class="n">opensuse</span><span class="o">-</span><span class="mi">11</span><span class="p">.</span><span class="n">markdown</span>
<span class="p">...</span>
<span class="p">...</span>
<span class="mi">2014</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">18</span><span class="o">-</span><span class="k">new</span><span class="o">-</span><span class="n">look</span><span class="o">-</span><span class="n">same</span><span class="o">-</span><span class="n">engine</span><span class="p">.</span><span class="n">markdown</span>
<span class="mi">2014</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">18</span><span class="o">-</span><span class="n">python</span><span class="o">-</span><span class="n">port</span><span class="o">-</span><span class="n">locker</span><span class="o">-</span><span class="n">slash</span><span class="o">-</span><span class="n">unlocker</span><span class="p">.</span><span class="n">markdown</span>
<span class="o">~/</span><span class="n">octopress</span><span class="o">/</span><span class="k">source</span><span class="o">/</span><span class="n">_posts$</span>
</pre></div>


<p>So we could generate the blog and check that it works. Let's run our docker container:</p>
<div class="highlight"><pre><span></span>$ sudo docker run --rm -v /home/docker/octopress/:/blogSRC bynario/octopress generate
</pre></div>


<ul>
<li><code>docker run --rm</code>: run Docker and automatically clean up the container and remove the file system when the container exits.</li>
<li><code>-v /home/docker/octopress/:/blogSRC</code>: Volume sharing. Mounting <code>/home/docker/octopress/</code> in the local machine as <code>/blogSRC</code> in the container.</li>
<li><code>bynario/octopress</code>: Image name and tag.</li>
<li><code>generate</code>: Rake command to be executed by the container.</li>
</ul>
<p>And finally let's create our git-hook. There are (at least) two different ways of working:</p>
<ul>
<li>Webhooks: The repository will communicate with a web server whenever the repository is pushed to.</li>
<li>Client-Side Hooks: Local scripts that are called when certain events occur.</li>
</ul>
<p>I chose the latter. So I configured a <code>post-merge</code> hook, that will be executed every time the content of my <code>_post</code> directory is updated after running a <code>git pull</code>:</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">docker</span> <span class="n">run</span> <span class="c1">--rm -v /home/docker/octopress/:/blogSRC bynario/octopress generate</span>
</pre></div>


<p>Don't forget the execution rights: <code>chmod +x /home/docker/octopress/source/_posts/.git/hooks/post-merge</code></p>
<p>Now, it is up to you how to call the git-hook. For example, you could run it manually every time you post something new or schedule it every night in crontab:</p>
<div class="highlight"><pre><span></span><span class="o">*</span> <span class="mi">00</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span>  <span class="n">cd</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">octopress</span><span class="o">/</span><span class="k">source</span><span class="o">/</span><span class="n">_posts</span> <span class="o">&amp;&amp;</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">git</span> <span class="n">pull</span> <span class="n">origin</span> <span class="n">master</span>
</pre></div>


<p>Happy blogging!</p></div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="/2014-10-18-python-port-locker-slash-unlocker.html">Python port locker/unlocker</a>
      </h1>
    <p class="meta">
<time datetime="2014-10-18T17:58:30+02:00" pubdate>Sat 18 October 2014</time>    </p>
</header>

  <div class="entry-content"><p>If you run you own server (VPS, cloud instances, bare metal, no matter what), I guess you check your log files almost on daily basis, and probably you already run any the multiple available tools (the list is pretty long, but in my case I use <a href="http://sourceforge.net/projects/logwatch/">logwatch</a>) that helps you out to keep an eye in what is going on in your machine.</p>
<p>There is one thing in particular that drives me crazy. As soon as you expose a machine to the internet, people will be constantly trying to get SSH access:</p>
<p>{% img center /img/logwatch_print.JPG  'logwatch' %}</p>
<p>Obviously, there are tools that will make your life easier (like <a href="http://www.fail2ban.org/wiki/index.php/Main_Page">fail2ban</a>, totally recommended) and some security tweaks (just Google for "linux server hardening") that you should be doing if you manage your own server, but even with all those things in place, I really don't like people trying to access to my server 24/7... Call me crazy, if you like.</p>
<p>A simple solution would have been just to change the SSH port to a something different, like 22222, and this might work for you. Unfortunately, I spend most of the time behind a proxy server, and I can only access the most common ports (the same very ones that are scanned on regular basis), so I needed to keep ssh service running in port 22.</p>
<p>Last year I coded a small bash script (just for myself) that allowed me to open and close SSH port on demand. It is been working fine since then, and I don't get annoyed by the ssh auth errors in logwath anymore. Now I migrated it to Python, and I thought it could be useful for anyone else, so here it is...</p>
<p>The script is not big deal, it will open/close certain ports that I preconfigured by reading a text file. Nothing new under the sun.</p>
<p>The only "particularity" of this script is that, instead of creating a service (webservice??) that allowed me to send the desired ssh state to the server (this would add another "attack vector"), I decided the script would pull the data from another location. I decided to use a (public) file in my dropbox folder. </p>
<p>If you want it to give it a try, these are the steps:</p>
<p>1 - Create a file in your dropbox folder and get the public link. Let's say that you get something like this: </p>
<div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">dropbox</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">s</span><span class="o">/</span><span class="n">XXXXXXXXXXXXXXXX</span><span class="o">/</span><span class="n">file</span>
</pre></div>


<p>2 - Add to this file any of the options you defined in the script. ie: </p>
<div class="highlight"><pre><span></span><span class="k">open</span> <span class="n">ssh</span>
<span class="k">close</span> <span class="n">vpn</span>
<span class="k">open</span>  <span class="n">httpd</span>
</pre></div>


<p>3 - Upload this script to your server (github link available in the code snippet header):</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#===============================================================================</span>
<span class="c1">#</span>
<span class="c1">#          FILE:  portLocker.py</span>
<span class="c1">#         USAGE:  python portLocker.py</span>
<span class="c1">#   DESCRIPTION:  port blocker/unblocker via dropbox file</span>
<span class="c1">#        AUTHOR:  http://bynario.com</span>
<span class="c1">#       CREATED:  05/08/2014 17:37:23 CEST</span>
<span class="c1">#===============================================================================</span>
<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span><span class="nn">sys</span><span class="o">,</span><span class="nn">os</span><span class="o">,</span><span class="nn">subprocess</span>

<span class="n">dbFile</span><span class="o">=</span><span class="s2">&quot;https://www.dropbox.com/s/XXXXXXXXXXXXXXXX/file&quot;</span>
<span class="n">logFile</span><span class="o">=</span><span class="s2">&quot;/var/log/locker_log.log&quot;</span>
<span class="n">htmlFile</span><span class="o">=</span><span class="s2">&quot;/usr/share/nginx/www/sshd.html&quot;</span>
<span class="n">servicesL</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ssh&#39;</span><span class="p">:</span><span class="s1">&#39;22&#39;</span><span class="p">,</span><span class="s1">&#39;vpn&#39;</span><span class="p">:</span><span class="s1">&#39;1723&#39;</span><span class="p">,</span><span class="s1">&#39;httpd&#39;</span><span class="p">:</span><span class="s1">&#39;80&#39;</span><span class="p">}</span>
<span class="n">actionsL</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="s1">&#39;close&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">createWWW</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">getTime</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">print2Log</span><span class="p">(</span><span class="n">logFile</span><span class="p">,</span><span class="s2">&quot;Error opening &quot;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot;: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">print2Log</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">text</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="n">text</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">print2Log</span><span class="p">(</span><span class="n">logFile</span><span class="p">,</span><span class="s2">&quot;Error opening &quot;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot;: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">print2WWW</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">service</span><span class="p">,</span><span class="n">status</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; - Service: &quot;</span> <span class="o">+</span> <span class="n">service</span> <span class="o">+</span> <span class="s2">&quot; - Status: &quot;</span> <span class="o">+</span> <span class="n">status</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">print2Log</span><span class="p">(</span><span class="n">logFile</span><span class="p">,</span><span class="s2">&quot;Error opening &quot;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot;: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">getTime</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">runCommand</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="n">retVal</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span><span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span><span class="n">shell</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">retVal</span><span class="p">:</span> <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">print2Log</span><span class="p">(</span><span class="n">logFile</span><span class="p">,</span><span class="s2">&quot;Error executing &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">command</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">checkDBFile</span><span class="p">():</span>
    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;/usr/bin/curl -s -L &quot;</span> <span class="o">+</span> <span class="n">dbFile</span>
    <span class="n">command</span><span class="o">=</span><span class="n">runCommand</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="n">retVal</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">command</span>

<span class="k">def</span> <span class="nf">runIptables</span><span class="p">(</span><span class="n">service</span><span class="p">,</span><span class="n">action</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; Running iptables... Service: &quot;</span> <span class="o">+</span> <span class="n">service</span> <span class="o">+</span> <span class="s2">&quot; Action:&quot;</span> <span class="o">+</span> <span class="n">action</span>
    <span class="n">check_command</span><span class="o">=</span><span class="s2">&quot;/sbin/iptables -C INPUT -p tcp -m tcp --dport &quot;</span> <span class="o">+</span> <span class="n">servicesL</span><span class="p">[</span><span class="n">service</span><span class="p">]</span> <span class="o">+</span><span class="s2">&quot; -j DROP&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">check_output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">check_command</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span><span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;close&quot;</span><span class="p">:</span> 
            <span class="n">command</span><span class="o">=</span><span class="s2">&quot;/sbin/iptables -A INPUT -p tcp --dport &quot;</span> <span class="o">+</span> <span class="n">servicesL</span><span class="p">[</span><span class="n">service</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; -j DROP&quot;</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;open&quot;</span><span class="p">:</span>
            <span class="n">command</span><span class="o">=</span><span class="s2">&quot;/sbin/iptables -D INPUT -p tcp --dport &quot;</span> <span class="o">+</span> <span class="n">servicesL</span><span class="p">[</span><span class="n">service</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; -j DROP&quot;</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">return</span>

    <span class="n">runCommand</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">createWWW</span><span class="p">(</span><span class="n">htmlFile</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">checkDBFile</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span> <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">print2Log</span><span class="p">(</span><span class="n">logFile</span><span class="p">,</span><span class="s2">&quot;Error in dropbox file: wrong format&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">act</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">serv</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">servicesL</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">serv</span><span class="p">)</span> <span class="ow">and</span> <span class="n">act</span> <span class="ow">in</span> <span class="n">actionsL</span><span class="p">:</span>
                <span class="n">runIptables</span><span class="p">(</span><span class="n">serv</span><span class="p">,</span><span class="n">act</span><span class="p">)</span>
                <span class="n">print2WWW</span><span class="p">(</span><span class="n">htmlFile</span><span class="p">,</span><span class="n">serv</span><span class="p">,</span><span class="n">act</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span>
                <span class="n">print2Log</span><span class="p">(</span><span class="n">logFile</span><span class="p">,</span><span class="s2">&quot;Service or Action found in file not valid... Skipping: &quot;</span> <span class="o">+</span> <span class="n">act</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">serv</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>4 - Now check these variables in the script:</p>
<div class="highlight"><pre><span></span><span class="n">dbFile</span><span class="o">=</span><span class="ss">&quot;https://www.dropbox.com/s/XXXXXXXXXXXXXXXX/file&quot;</span>
<span class="n">logFile</span><span class="o">=</span><span class="ss">&quot;/var/log/locker_log.log&quot;</span>
<span class="n">htmlFile</span><span class="o">=</span><span class="ss">&quot;/usr/share/nginx/www/sshd.html&quot;</span>
<span class="n">servicesL</span><span class="o">=</span><span class="err">{</span><span class="s1">&#39;ssh&#39;</span><span class="p">:</span><span class="s1">&#39;22&#39;</span><span class="p">,</span><span class="s1">&#39;vpn&#39;</span><span class="p">:</span><span class="s1">&#39;1723&#39;</span><span class="p">,</span><span class="s1">&#39;httpd&#39;</span><span class="p">:</span><span class="s1">&#39;80&#39;</span><span class="err">}</span>
</pre></div>


<p>Adapt the script to fit your environment:</p>
<ul>
<li>Replace <em>dbFile</em> by the URL you got from Dropbox</li>
<li>Set the path you need for the <em>logFile</em></li>
<li>The script will write the status of the services to my web server, so I can check the status easily. Set your path in <em>htmlFile</em>.</li>
<li>Define the list of services you want to manage in <em>servicesL</em>. This has to match with the info you define in the dropbox file.</li>
</ul>
<p>5 - Create an entry in crontab with the periodicity you need. In my case, opening/closing ssh port is not critical, so, as I don't want Dropbox people to get angry at me, I set it up to 5 minutes :)</p>
<div class="highlight"><pre><span></span> <span class="o">*/</span><span class="mi">5</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="n">python</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="k">to</span><span class="o">/</span><span class="n">portLocker</span><span class="p">.</span><span class="n">py</span> <span class="o">&amp;&gt;&gt;</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">locker_log</span><span class="p">.</span><span class="n">log</span>
</pre></div>


<p>Now all you need to do is modify your dropbox file, and after a few minutes, check if you get the result you expected ;)</p>
<p>There is one main improvement that could be done, and it is adding some kind of signature to the file in order to ensure nobody is messing with us, but I have pretty good reasons not to do it (at the moment):</p>
<ul>
<li>I update the dropbox file from mobile devices every now and then, and adding a signature to the file would make this way too complex.</li>
<li>This file is stored in my dropbox folder, so <strong>theoretically</strong>, nobody but me is able to modify it.</li>
<li>The security of the server does not rely on this script. This is not meant to be "<a href="https://en.wikipedia.org/wiki/Security_through_obscurity">security through obscurity</a>".</li>
</ul>
<p>If you are after something more professional, I recommend you to check <a href="https://www.elevenpaths.com/technology/latch/index.html">Latch</a>.</p>
<p>And that's all folks... It is working pretty well for me, and I hope it works for you... </p>
<p>See you around</p></div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="/2014-10-18-new-look-same-engine.html">New look. Same engine</a>
      </h1>
    <p class="meta">
<time datetime="2014-10-18T16:35:28+02:00" pubdate>Sat 18 October 2014</time>    </p>
</header>

  <div class="entry-content"><p>Dear reader, if you have ever been in a (long) business trip, you would problably agree with me on this:</p>
<p><strong><em>"At the end, long business trips are pretty boring"</em></strong> <em>(ok, ok, it depends on the place)</em></p>
<p>I have been in Amman (Jordan) for the past few weeks. I have seeing what could be seen around (not that much IMO), but since now I have some "spare" time, I have decided to take another look at Octopress.  (I still think I would be better off without Ruby though :-P)</p>
<p>So, as you can see, I have modified the CSS of the site to make it cleaner and lighter, because I never really like dark styles.</p>
<p>Actually, this is how bynario.com looked like in 2005 (I found this in <a href="https://www.archive.org">archive.org</a>):</p>
<p>{% img center /img/bynarioSS-feb2006.JPG  '2006' %}</p>
<p>And this is in 2011 (I hosted this site in blogger for a few months):</p>
<p>{% img center /img/bynarioSS-oct2011.JPG  '2011' %}</p>
<p>And finally, since June 2012, I have been running Octopress with just some small modifications over the default theme:</p>
<p>{% img center /img/bynarioSS-oct2014.JPG  '2014' %}</p>
<p>Now I just need to stop procrastinating and post more often... Easier said than done!</p>
<p>Bye</p></div>
  		</article>
<div class="pagination">
    <a class="prev" href="/index10.html">&larr; Older</a>

    <a class="next" href="/index8.html">Newer &rarr;</a>
  <br />
</div></div>
<aside class="sidebar">
  <section>
	  <img src="https://dl.dropboxusercontent.com/u/14814182/blog/roundPic.gif" alt="" width=""/> 
  </section>
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="/2018-05-15-batch-macos-convert-resize-nef-to-jpg.html">NEF batch processing in MacOS (from CLI)</a>
      </li>
      <li class="post">
          <a href="/2018-02-17-psa_minikeepass_and_key_files.html">PSA: MiniKeePass and key files</a>
      </li>
      <li class="post">
          <a href="/2017-12-31-bye-bye-2017_hello-2018.html">Bye bye 2017, hello 2018</a>
      </li>
      <li class="post">
          <a href="/2017-08-25-string-manipulation-exercise-perl-python-awk.html">String manipulation exercise: Perl, Python, Awk</a>
      </li>
      <li class="post">
          <a href="/2017-06-05-issues-running-gpg-in-a-container.html">Issues running gpg in a container</a>
      </li>
    </ul>
  </section>

  <section>
  <h1>Tags</h1>
    <a href="/tag/pelican.html">pelican</a>,    <a href="/tag/google.html">google</a>,    <a href="/tag/data-science.html">data science</a>,    <a href="/tag/telegram.html">telegram</a>,    <a href="/tag/coding.html">coding</a>,    <a href="/tag/blogging.html">blogging</a>,    <a href="/tag/books.html">books</a>,    <a href="/tag/linux.html">linux</a>,    <a href="/tag/images.html">images</a>,    <a href="/tag/technology.html">technology</a>,    <a href="/tag/bynario.html">bynario</a>,    <a href="/tag/spotify.html">spotify</a>,    <a href="/tag/git.html">Git</a>,    <a href="/tag/networking.html">networking</a>,    <a href="/tag/ads.html">ads</a>,    <a href="/tag/quickthoughts.html">quickthoughts</a>,    <a href="/tag/spam.html">spam</a>,    <a href="/tag/tv.html">tv</a>,    <a href="/tag/octopress.html">octopress</a>,    <a href="/tag/psgonza.html">psgonza</a>,    <a href="/tag/synology.html">synology</a>,    <a href="/tag/perl.html">perl</a>,    <a href="/tag/nas.html">nas</a>,    <a href="/tag/internet.html">internet</a>,    <a href="/tag/interview.html">interview</a>,    <a href="/tag/2014.html">2014</a>,    <a href="/tag/2017.html">2017</a>,    <a href="/tag/2016.html">2016</a>,    <a href="/tag/iptables.html">iptables</a>,    <a href="/tag/kubernetes.html">kubernetes</a>,    <a href="/tag/python.html">python</a>,    <a href="/tag/ntp.html">ntp</a>,    <a href="/tag/2015.html">2015</a>,    <a href="/tag/keepass.html">keepass</a>,    <a href="/tag/photos.html">photos</a>,    <a href="/tag/ssmtp.html">ssmtp</a>,    <a href="/tag/awk.html">awk</a>,    <a href="/tag/cygwin.html">cygwin</a>,    <a href="/tag/meetups.html">meetups</a>,    <a href="/tag/scripts.html">scripts</a>,    <a href="/tag/ipython.html">ipython</a>,    <a href="/tag/monitoring.html">monitoring</a>,    <a href="/tag/security.html">security</a>,    <a href="/tag/bash.html">bash</a>,    <a href="/tag/rss.html">rss</a>,    <a href="/tag/macos.html">macos</a>,    <a href="/tag/tips.html">tips</a>,    <a href="/tag/geotagging.html">geotagging</a>,    <a href="/tag/ssl.html">ssl</a>,    <a href="/tag/windows.html">windows</a>,    <a href="/tag/blogs.html">blogs</a>,    <a href="/tag/privacy.html">privacy</a>,    <a href="/tag/programming.html">programming</a>,    <a href="/tag/cli.html">cli</a>,    <a href="/tag/podcasts.html">podcasts</a>,    <a href="/tag/ansible.html">ansible</a>,    <a href="/tag/opinion.html">opinion</a>,    <a href="/tag/docker.html">docker</a>,    <a href="/tag/note2self.html">note2self</a>,    <a href="/tag/scripting.html">scripting</a>  </section>



  <section>
    <h1>GitHub Repos</h1>
    <ul id="gh_repos">
      <p><a href="https://github.com/psgonza">@psgonza</a></p>
    </ul>
    <script type="text/javascript">
      $.domReady(function(){
          if (!window.jXHR){
              var jxhr = document.createElement('script');
              jxhr.type = 'text/javascript';
              jxhr.src = '/theme/js/jXHR.js';
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(jxhr, s);
          }

          github.showRepos({
              user: 'psgonza',
              count: 5,
              skip_forks: false,
              target: '#gh_repos'
          });
      });
    </script>
    <script src="/theme/js/github.js" type="text/javascript"> </script>
  </section>

    <section>
        <h1>Social</h1>
        <ul>
            <li><a href="/rss.xml" type="application/rss+xml" rel="alternate">RSS</a></li>
            <li><a href="#" target="_blank">You can add links in your config file</a></li>
            <li><a href="#" target="_blank">Another social link</a></li>
        </ul>
    </section>
    <section>
        <h1>Blogroll</h1>
        <ul>
            <li><a href="http://getpelican.com/" target="_blank">Pelican</a></li>
            <li><a href="http://python.org/" target="_blank">Python.org</a></li>
            <li><a href="http://jinja.pocoo.org/" target="_blank">Jinja2</a></li>
            <li><a href="#" target="_blank">You can modify those links in your config file</a></li>
        </ul>
    </section>

<section>
   <h1>Tweeter</h1>
    <p>Follow <a href="http://twitter.com/psgonza">@psgonza</a></p>
</section>
</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2011&ndash;2018  psgonza &mdash;
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
  <script src="/theme/js/modernizr-2.0.js"></script>
  <script src="/theme/js/ender.js"></script>
  <script src="/theme/js/octopress.js" type="text/javascript"></script>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-90925-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-90925-1');
    ga('send', 'pageview');
</script>
  <script type="text/javascript">
    var disqus_shortname = 'bynario';
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = "//" + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
  </script>
</body>
</html>